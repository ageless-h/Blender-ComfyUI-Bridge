# Blender-ComfyUI Bridge

一个Blender插件，作为在Blender和ComfyUI之间进行实时、双向通信的桥梁。

这个插件允许您在Blender中一键将渲染结果或图像数据无缝地发送到ComfyUI中一个预设好的工作流进行处理，然后将处理后的图像自动返回到Blender中。

## ✨ 功能特性

*   **一键发送数据**: 在Blender的3D视图侧边栏中提供一个简洁的UI面板，点击按钮即可渲染当前场景并将图像数据发送到ComfyUI。
*   **强大的图像格式支持**:
    *   **标准图像 (PNG/JPG)**: 快速发送预览图。
    *   **多通道EXR (Multi-Layer EXR)**: 将所有渲染通道 (如 `Depth`, `Mist`, `Normal`, `AO` 等) 无损地打包到一个 EXR 文件中发送，为下游的图像处理提供最大的灵活性。
*   **灵活的网络连接**:
    *   **直接连接**: 在本地网络环境中直接连接到ComfyUI。
    *   **SSH隧道**: 内置SSH隧道功能，允许您通过安全的SSH连接，将本地Blender实例与远程服务器上的ComfyUI无缝对接，无需手动配置端口转发。
*   **智能数据传输**: 插件通过内存直接发送图像的二进制数据，无需共享文件系统，支持跨机器、跨容器的复杂网络环境。
*   **实时连接状态**: UI会实时显示与ComfyUI的连接状态（已连接/未连接）。
*   **双向通信**:
    *   **Blender -> ComfyUI**: 通过ZMQ发送渲染任务、元数据和图像二进制数据。
    *   **ComfyUI -> Blender**: 通过HTTP将处理完成的图像数据发送回Blender。
*   **全自动依赖管理**: 插件首次启用时，会自动通过Blender内置的Python环境安装所有必需的依赖库 (`sshtunnel`, `paramiko`, `pyzmq`, `msgspec`)，无需手动操作。
*   **后台任务处理**: 使用Blender的`bpy.app.timers`来稳定地处理来自ComfyUI的异步任务，不阻塞UI。
*   **健壮的错误处理**: 包含连接测试、超时和错误报告机制。

## 🚀 安装指南

### 1. ComfyUI 节点

首先，确保您已经在ComfyUI中安装了兼容的接收节点。该节点需要能够处理来自Blender的多部分ZMQ消息。

### 2. Blender 插件

1.  **下载**: 从本GitHub仓库的 "Releases" 页面下载最新的 `Blender-ComfyUI-Bridge-vX.X.zip` 文件。
2.  **安装**:
    *   打开Blender，进入 `编辑` > `偏好设置` > `插件`。
    *   点击 `安装...` 按钮，选择您刚刚下载的 `.zip` 文件。
    *   在插件列表中找到 "Blender-ComfyUI Bridge" 并勾选以启用它。
3.  **依赖安装**:
    *   插件在首次启用时，会自动检测并安装所需的Python依赖库。此过程需要网络连接，并可能需要几十秒到几分钟的时间。
    *   您可以通过Blender的 `窗口` > `切换系统控制台` 菜单来查看详细的安装进度和日志。安装完成后，建议重启Blender以确保所有模块都已正确加载。

## 🔧 使用方法

1.  在Blender的3D视图中，按 `N` 键打开侧边栏，找到 `ComfyUI` 选项卡。

2.  **配置连接**:
    *   **直接连接**: 如果您的ComfyUI与Blender在同一本地网络，直接在"连接设置"中输入ComfyUI服务器的ZMQ地址 (例如 `127.0.0.1:5555`)。
    *   **通过SSH隧道连接**:
        *   展开 "SSH 隧道" 面板。
        *   勾选 "启用 SSH 隧道"。
        *   填写您的SSH服务器信息（主机、端口、用户名、密码或私钥路径）。
        *   **重要**: 此时，"连接设置"中的"ComfyUI 服务器地址"应填写ComfyUI**相对于SSH服务器**的地址（例如，如果ComfyUI和SSH服务器在同一台机器上，通常填写 `127.0.0.1:5555`）。
        *   插件会自动建立隧道，将远程ComfyUI的端口映射到您的本地。

3.  点击 **"测试连接"**，直到状态显示为"已连接"。

4.  在"结果接收"区域，点击文件夹图标，选择一个图像数据块用于接收ComfyUI返回的结果。

5.  在"数据发送"区域，选择您的发送模式：
    *   **渲染结果**: 渲染当前场景并发送。可以选择"标准图像"或"多通道 EXR"。
    *   **图像编辑器**: 直接发送当前在图像编辑器中打开的图像。

6.  点击 **"渲染并发送"** 或 **"发送当前图像"** 按钮，数据将被发送到ComfyUI。

7.  ComfyUI处理完成后，结果会自动出现在您选择的目标图像数据块上。

---

## 💻 技术实现细节 (供节点开发者参考)

本插件通过ZMQ的`REQ/REP`模式与ComfyUI节点通信，并采用**多部分消息 (Multipart Message)** 的格式发送数据。

### ZMQ 消息结构

节点接收到的ZMQ消息包含 **2** 个部分：

1.  **Part 1: 元数据 (Metadata)**
    *   **类型**: `msgspec` 编码的字典 (JSON)。
    *   **内容**: 包含操作指令和图像信息。

2.  **Part 2: 图像二进制数据 (Image Bytes)**
    *   **类型**: 原始字节流 (`bytes`)。
    *   **内容**: `.png` 或 `.exr` 文件的完整二进制内容。

**接收节点必须使用 `socket.recv_multipart()` 来正确解析这两个部分。**

### 元数据 (Metadata) 详解

元数据字典中包含以下关键字段：

*   `render_type` (字符串):
    *   `'standard'`: 表示第二部分数据是标准的 **PNG/JPG** 图像。
    *   `'multilayer_exr'`: 表示第二部分数据是多通道 **EXR** 图像。
    *   **接收节点必须根据此字段来决定处理逻辑。**

*   `channel_map` (字典):
    *   **仅在 `render_type` 为 `'multilayer_exr'` 时提供。**
    *   这是一个"翻译地图"，用于将ComfyUI期望的通道名 (key) 映射到EXR文件中实际的通道名 (value)。
    *   **示例**: `{'volume_direct': 'ViewLayer.VolumeDir', 'ambient_occlusion': 'ViewLayer.AO'}`
    *   **接收节点在处理EXR时，必须使用此map来查找通道，而不是硬编码通道名。**